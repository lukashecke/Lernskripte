# AP-Test (JDBC) am 16.02.22 um 11:45 Uhr

JDBC steht für *Java Database Connectivity*.  
Es ist eine Java Datenbankschnittstelle, die es ermöglicht, relationale Datenbanken verschiedener Hersteller über eine einheitliche Schnittstelle anzusprechen.

## Treiber

- Typ 1: JDBC-ODBC bridge plus ODBC driver:  
Die Verbindung zur Datenbank wird über ODBC hergestellt. Dabei stellt der JDBC-Treiber nur eine Kapse-
lung der Aufrufe dar. Zusätzlich muss der ODBC-Treiber installiert werden.
- Typ 2: Native-API partly-Java driver:  
Die Verbindung wird über einen Datenbanktreiber hergestellt. Der JDBC-Treiber ruft die entsprechenden
Datenbank-Client-Funktionen auf. Der DBMS-Client muss dabei installiert sein.
- Typ 3: JDBC-Net pure Java driver:  
Hier werden durch den JDBC-Treiber die Aufrufe in das entsprechende Protokoll übersetzt und dann von
einem entsprechenden Server (middleware) in das DBMS-Protokoll übersetzt und an das DBMS geschickt.
- Typ 4: Native-protocol pure Java driver:  
Hier werden durch den JDBC-Treiber die Aufrufe direkt in das Netzwerkprotokoll des DBMS übersetzt.
Hierzu muss aber das entsprechende proprietäre Protokoll des DBMS unterstützt werden

## Aufbau eines JDBC Programms

### 1. DB Verbindung

Der benötigte Connection String setzt sich in JDBC wie folgt zusammen:

```text
jdbc:mysql://localhost:3306/BEISPIEL
jdbc:mysql://localhost:3306/fb2?allowMultiQueries=true
```

Dieser Connection String wird dem `DriverManager` zusammen mit dem Benutzer und dem Passwort übergeben um mit `getConnection` die Verbindung zur Datenbank aufzubauen:

```java
Connection connection = DriverManager.getConnection("jdbc:mysql://localhost:3306/fb2?allowMultiQueries=true", "root", "0000");
```

> Vorsicht!  
> Der Connection String kann nur aufgelöst werden, wenn die Datenbank bereits existiert.

### 2. SQL-Statement

Zu erst muss ein Objekt vom Typ `Statement` erzeugt werden:

```java
Statement statement = connection.createStatement();
```

Damit kann die SQL-Abfrage ausgeführt werden:

```java
int rowsUpdated = statement.executeUpdate("DROP TABLE IF EXISTS LIEFERANT");

rowsUpdated = statement.executeUpdate("CREATE TABLE LIEFERANT ...");
```

Anstatt jede Abfrage einzeln auszuführen, können wir einen Batch (Gruppe) von Abfragen ausführen:

```java
statement.addBatch("INSERT INTO LIEFERANT SET name=\"Niedermair\"");
statement.addBatch("INSERT INTO LIEFERANT SET name=\"Müller\"");
statement.addBatch("INSERT INTO LIEFERANT SET name=\"Maier\"");
int[] updateCounts = statement.executeBatch();
```

### 3. ResultSet (alle Übungen die im Unterricht besprochen)

"A table of data representing a database result set, which is usually generated by executing a statement that queries the database."

```java
ResultSet rs = statement.executeQuery("SELECT * FROM Spieler");
```

Spaltenanzahl der Datenbanktabelle den Metadaten mit `getMetaData()` holen:

```java
ResultSetMetaData meta = rs.getMetaData();
int colmax = meta.getColumnCount();
```

Durch die zurückgegebenen Datensätze mittels `next()` iterieren:

```java
while (rs.next()) {
    for (int i = 1; i <= colmax; ++i) {
        Object o = rs.getObject(i);
        System.out.print(o == null ? "null" : o);
        System.out.print(" | ");
    }
    System.out.println();
}
```

Folgende Ausgabe:

```text
1 | 1 | Lahm | Philpp | 21 | 1983-11-11 | männlich | GER | 910000.00 | 
2 | 1 | Badstuber | Holger | 28 | 1989-03-13 | männlich | GER | 420970.00 | 
3 | 1 | Ribéry | Franck | 7 | 1983-04-07 | männlich | FRA | 857500.00 | 
4 | 1 | Martínez | Javier | 8 | 1988-09-02 | männlich | ESP | 900000.00 | 
5 | 2 | Brouwers | Roel | 4 | 1981-11-28 | männlich | BRA | 300000.00 | 
...
```

Zum einfügen von Daten mus der "Zeiger" des `ResultSet`-Objekts auf die `InsertRow` umgestellt werden, um Dort die einzelnen Daten zu ändern um anschließend diesen neuen Datensatz einzusetzen:

```java
rs.moveToInsertRow();
rs.updateInt("id", 1);
rs.updateString("name", "Meier");
rs.updateInt("gehalt", 100);
rs.insertRow();
```

### 4. Datenbankverbindung schließen

Abschließend sollten alle `Connection`- und `Statement`-Objekte geschlossen werden um alle Resource wieder freizugeben:

```java
connection.close();
statement.close();
```

> `Connection` implementiert die Methode `close()` aus dem Interface `AutoCloseable` und kann über diese geschlossen werden:

### PreparedStatements

folgt...
